const hSize=10,wSize=9;class Piece{static role={empty:0,i:1,t:2,o:3,h:4,P:5,l:6,m:7};static g={[Piece.role.empty]:"empty",[Piece.role.i]:"captain",[Piece.role.t]:"guard",[Piece.role.o]:"elephant",[Piece.role.h]:"horse",[Piece.role.P]:"car",[Piece.role.l]:"duck",[Piece.role.m]:"soldier"};static u={[Piece.role.empty]:"",[Piece.role.i]:"王",[Piece.role.t]:"士",[Piece.role.o]:"象",[Piece.role.h]:"马",[Piece.role.P]:"车",[Piece.role.l]:"鸭",[Piece.role.m]:"兵"};static S={[Piece.role.empty]:()=>!1,[Piece.role.i]:(i,c,t,n)=>{return[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}].some(e=>i+e.x===t&&c+e.y===n)},[Piece.role.t]:(i,c,t,n)=>{return[{x:1,y:1},{x:1,y:-1},{x:-1,y:1},{x:-1,y:-1}].some(e=>i+e.x===t&&c+e.y===n)},[Piece.role.o]:(i,c,t,n)=>{return[{x:2,y:2,R:1,p:1},{x:2,y:-2,R:1,p:-1},{x:-2,y:2,R:-1,p:1},{x:-2,y:-2,R:-1,p:-1}].some(e=>i+e.x===t&&c+e.y===n&&map[i+e.R][c+e.p].k())},[Piece.role.h]:(i,c,t,n)=>{return[{x:-1,y:2,R:0,p:1},{x:1,y:2,R:0,p:1},{x:2,y:1,R:1,p:0},{x:2,y:-1,R:1,p:0},{x:1,y:-2,R:0,p:-1},{x:-1,y:-2,R:0,p:-1},{x:-2,y:-1,R:-1,p:0},{x:-2,y:1,R:-1,p:0}].some(e=>i+e.x===t&&c+e.y===n&&map[i+e.R][c+e.p].k())},[Piece.role.P]:(e,i,c,t)=>{var n,a;return e===c&&i!==t?([n,a]=i<t?[i,t]:[t,i],map[e].slice(n+1,a).every(e=>e.k())):i===t&&e!==c&&([n,a]=e<c?[e,c]:[c,e],map.slice(n+1,a).every(e=>e[i].k()))},[Piece.role.l]:(i,c,t,n)=>{return[{dx:1,dy:1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:-1,dy:-1}].some(e=>i+3*e.dx===t&&c+2*e.dy===n&&map[i+2*e.dx][c+e.dy].k()&&map[i+e.dx][c].k()||i+2*e.dx===t&&c+3*e.dy===n&&map[i+e.dx][c+2*e.dy].k()&&map[i][c+e.dy].k())},[Piece.role.m]:(i,c,t,n)=>{return[{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:1},{x:0,y:-1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1}].some(e=>i+e.x===t&&c+e.y===n)}};constructor(e,i=0){this.type=e,this.C=i,this.name=Piece.g[e],this.u=Piece.u[e]}setPosition(e,i){this.x=e,this.y=i}v(e,i){return!(e<0||i<0||e>=hSize||i>=wSize||this.C!==curTeam||map[e][i].C===curTeam)&&Piece.S[this.type](this.x,this.y,e,i)}k(){return 0===this.type}T(){1===this.type&&(curTeam=3,text=`${1===this.C?"蓝":"红"}方胜利`,curtain=curtainTime,textColor=curtainColor=1===this.C?"#00f":"#f00")}}class Rect{constructor(e,i,c,t){this.left=e,this.top=i,this.right=c,this.bottom=t}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get L(){return(this.left+this.right)/2}get A(){return(this.top+this.bottom)/2}}const initMap=[[new Piece(Piece.role.P,1),new Piece(Piece.role.h,1),new Piece(Piece.role.o,1),new Piece(Piece.role.t,1),new Piece(Piece.role.i,1),new Piece(Piece.role.t,1),new Piece(Piece.role.o,1),new Piece(Piece.role.h,1),new Piece(Piece.role.P,1)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(Piece.role.l,1),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(Piece.role.l,1)],[new Piece(Piece.role.m,1),new Piece(0),new Piece(Piece.role.m,1),new Piece(0),new Piece(Piece.role.m,1),new Piece(0),new Piece(Piece.role.m,1),new Piece(0),new Piece(Piece.role.m,1)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(Piece.role.m,2),new Piece(0),new Piece(Piece.role.m,2),new Piece(0),new Piece(Piece.role.m,2),new Piece(0),new Piece(Piece.role.m,2),new Piece(0),new Piece(Piece.role.m,2)],[new Piece(Piece.role.l,2),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(Piece.role.l,2)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(Piece.role.P,2),new Piece(Piece.role.h,2),new Piece(Piece.role.o,2),new Piece(Piece.role.t,2),new Piece(Piece.role.i,2),new Piece(Piece.role.t,2),new Piece(Piece.role.o,2),new Piece(Piece.role.h,2),new Piece(Piece.role.P,2)]],blockSize=80,boardRect=new Rect(40,40,40+wSize*blockSize,40+hSize*blockSize),textRect=new Rect(boardRect.left+10,boardRect.bottom+40,boardRect.right-10,boardRect.bottom+80),stageRect=new Rect(0,0,boardRect.right+40,textRect.bottom+40),menuRect=new Rect(stageRect.right,0,stageRect.right+600,stageRect.bottom),appRect=new Rect(0,0,menuRect.right,menuRect.bottom),errShowTime=40,shineTime=40,shakeTime=10,curtainTime=60,shakeDis=[0,1,1,2,2,3,4,6,9,13,20];let map=[],badClick=[],shine=[],canChoose=[],move=0,stage,ctx,menu,restart,text="红方下棋",textColor="#f00",curtain=0,curtainColor,windowWidth,windowHeight;function resize(){windowWidth=document.documentElement.clientWidth,windowHeight=document.documentElement.clientHeight;var e=Math.min(windowWidth/appRect.width,windowHeight/appRect.height);stage.css({width:stageRect.width*e,height:stageRect.height*e}),menu.css({width:menuRect.width*e,height:menuRect.height*e-200,fontSize:24*e,padding:20*e})}function init(){initMap.forEach((e,c)=>{map[c]=[...e],e.forEach((e,i)=>{e.setPosition(c,i)})}),badClick=Array(hSize).fill().map(()=>Array(wSize).fill(0)),shine=Array(hSize).fill().map(()=>Array(wSize).fill(0)),canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),stage=$(`<canvas width='${stageRect.width}' height='${stageRect.height}'></canvas>`),ctx=stage[0].getContext("2d"),menu=$("<div id='menu'><h3>菜单</h3><fieldset><legend>操作</legend></fieldset><fieldset><legend>关于</legend><p>这个项目由 <a href='https://github.com/caibyte'>caibyte</a> 编写</p><p><a href='https://github.com/caibyte/DuckchessOnline'>github链接</a>&nbsp;&nbsp;<a href='http://alfredoj.natapp1.cc/static/games/DuckchessOnline/LICENSE.html'>MIT条款</a></p></fieldset><fieldset><legend>规则</legend><a href='https://www.luogu.com.cn/problem/P5380'>点我查看</a></fieldset></div>"),restart=$('<button class="btn">重新开始</button>'),menu.children("fieldset")[0].append(restart[0]),resize(),restart.click(()=>{initMap.forEach((e,c)=>{map[c]=[...e],e.forEach((e,i)=>{e.setPosition(c,i)})}),shine=Array(hSize).fill().map(()=>Array(wSize).fill(0)),canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),curTeam=1,text="红方下棋",textColor="#f00",curtainColor="#fff",curtain=curtainTime}),stage.click(e=>{console.log(e),click.push({x:e.offsetX/stage.width()*stageRect.width,y:e.offsetY/stage.height()*stageRect.height})}),stage.mousemove(e=>{var i=(boardRect.bottom-e.offsetY/stage.height()*stageRect.height)/blockSize|0,e=(e.offsetX/stage.width()*stageRect.width-boardRect.left)/blockSize|0;hovering=i<0||i>=hSize||e<0||e>=wSize?null:{x:i,y:e}}),$("#main").append(stage).append(menu),$("#loading").hide()}window.addEventListener("resize",resize);let curTeam=1,hovering=null,selecting=null,click=[];function update(){click.forEach(e=>{var c=(boardRect.bottom-e.y)/blockSize|0,t=(e.x-boardRect.left)/blockSize|0;if(!(c<0||c>=hSize||t<0||t>=wSize))if(null===selecting)if(map[c][t].C===curTeam){selecting={x:c,y:t};for(let i=0;i<hSize;++i)for(let e=0;e<wSize;++e)canChoose[i][e]=map[c][t].v(i,e)}else canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),badClick[c][t]=errShowTime;else if(map[selecting.x][selecting.y].v(c,t))curTeam=3-curTeam,text=`${1===curTeam?"红":"蓝"}方下棋`,textColor=1===curTeam?"#f00":"#00f",shine[selecting.x][selecting.y]=0,shine[c][t]=shineTime,move=shakeTime,canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),map[c][t].T(),map[selecting.x][selecting.y].setPosition(c,t),map[c][t]=map[selecting.x][selecting.y],map[selecting.x][selecting.y]=new Piece(0),selecting=null;else if(map[c][t].C===curTeam){selecting={x:c,y:t};for(let i=0;i<hSize;++i)for(let e=0;e<wSize;++e)canChoose[i][e]=map[c][t].v(i,e)}else selecting=null,canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),badClick[c][t]=errShowTime}),click=[],curtain&&--curtain,move&&--move;for(let i=0;i<hSize;++i)for(let e=0;e<wSize;++e)badClick[i][e]&&--badClick[i][e],shine[i][e]&&--shine[i][e]}function render(){ctx.clearRect(stageRect.left,stageRect.top,stageRect.width,stageRect.height),ctx.save(),ctx.translate(0,shakeDis[move]);var e,i;ctx.fillStyle="#fd4",ctx.fillRect(boardRect.left,boardRect.top,boardRect.width,boardRect.height),ctx.strokeStyle="#640",ctx.lineWidth=3;for(let e=0;e<wSize;++e)ctx.beginPath(),ctx.moveTo(boardRect.left+blockSize/2+e*blockSize,boardRect.top+blockSize/2),ctx.lineTo(boardRect.left+blockSize/2+e*blockSize,boardRect.bottom-blockSize/2),ctx.stroke(),ctx.closePath(),ctx.fillStyle="#666",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="30px sans-serif",ctx.fillText(e,boardRect.left+blockSize/2+e*blockSize,boardRect.bottom+15);for(let e=0;e<hSize;++e)ctx.beginPath(),ctx.moveTo(boardRect.left+blockSize/2,boardRect.top+blockSize/2+e*blockSize),ctx.lineTo(boardRect.right-blockSize/2,boardRect.top+blockSize/2+e*blockSize),ctx.stroke(),ctx.closePath(),ctx.fillStyle="#666",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="30px sans-serif",ctx.fillText(hSize-e-1,boardRect.left-15,boardRect.top+blockSize/2+e*blockSize);hovering&&(map[hovering.x][hovering.y].C===curTeam||canChoose[hovering.x][hovering.y])&&(e=boardRect.left+blockSize/2+hovering.y*blockSize,i=boardRect.bottom-blockSize/2-hovering.x*blockSize,ctx.M(e,i,20,35,4,"#fff")),selecting&&(e=boardRect.left+blockSize/2+selecting.y*blockSize,i=boardRect.bottom-blockSize/2-selecting.x*blockSize,ctx.M(e,i,20,35,4,"#7f8"));for(let i=0;i<hSize;++i)for(let e=0;e<wSize;++e){var c=boardRect.left+blockSize/2+e*blockSize,t=boardRect.bottom-blockSize/2-i*blockSize;ctx.M(c,t,20,35,4,"#f44"+(badClick[i][e]/errShowTime*15|0).toString(16)),map[i][e].k()||(ctx.beginPath(),ctx.arc(c,6+t,30,0,2*Math.PI),ctx.fillStyle="#0007",ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.arc(c,t,30,0,2*Math.PI),ctx.fillStyle="#eee",ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.arc(c,3+t,30,0,2*Math.PI),ctx.fillStyle="#eee",ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.arc(c,t,26,0,2*Math.PI),ctx.strokeStyle=1===map[i][e].C?"#f00":"#00f",ctx.lineWidth=2,ctx.stroke(),ctx.closePath(),ctx.fillStyle=1===map[i][e].C?"#f00":"#00f",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="25px sans-serif",ctx.fillText(map[i][e].u,c,t),ctx.beginPath(),ctx.arc(c,t,30,0,2*Math.PI),ctx.fillStyle="#fff"+(shine[i][e]/shineTime*13|0).toString(16),ctx.fill(),ctx.closePath()),canChoose[i][e]&&(ctx.beginPath(),ctx.arc(c,t,10,0,2*Math.PI),ctx.fillStyle="#3f4d",ctx.fill(),ctx.closePath())}ctx.fillStyle="#ccc",ctx.fillRect(textRect.left,textRect.top,textRect.width,textRect.height),ctx.fillStyle=textColor,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="30px sans-serif",ctx.fillText(text,textRect.L,textRect.A),curtain&&(ctx.fillStyle=curtainColor+(curtain/curtainTime*10|0).toString(16),ctx.fillRect(stageRect.left,stageRect.top,stageRect.width,stageRect.height)),ctx.restore()}function main(){update(),render(),requestAnimationFrame(main)}CanvasRenderingContext2D.prototype.M=function(e,i,c,t,n,a){this.strokeStyle=a,this.lineWidth=n,this.beginPath(),this.moveTo(e-t,i-t-n/2),this.lineTo(e-t,i-c),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e-t+n/2,i-t),this.lineTo(e-c,i-t),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+t,i-t-n/2),this.lineTo(e+t,i-c),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+t-n/2,i-t),this.lineTo(e+c,i-t),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e-t,i+t+n/2),this.lineTo(e-t,i+c),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e-t+n/2,i+t),this.lineTo(e-c,i+t),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+t,i+t+n/2),this.lineTo(e+t,i+c),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+t-n/2,i+t),this.lineTo(e+c,i+t),this.stroke(),this.closePath()},window.addEventListener("load",()=>{init(),main()});