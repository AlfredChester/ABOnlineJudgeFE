const hSize=10,wSize=9;class Piece{static role={empty:0,captain:1,guard:2,elephant:3,horse:4,car:5,duck:6,soldier:7};static str={[Piece.role.empty]:"empty",[Piece.role.captain]:"captain",[Piece.role.guard]:"guard",[Piece.role.elephant]:"elephant",[Piece.role.horse]:"horse",[Piece.role.car]:"car",[Piece.role.duck]:"duck",[Piece.role.soldier]:"soldier"};static cName={[Piece.role.empty]:"",[Piece.role.captain]:"王",[Piece.role.guard]:"士",[Piece.role.elephant]:"象",[Piece.role.horse]:"马",[Piece.role.car]:"车",[Piece.role.duck]:"鸭",[Piece.role.soldier]:"兵"};static moveChk={[Piece.role.empty]:()=>!1,[Piece.role.captain]:(t,i,c,o)=>{return[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}].some(e=>t+e.x===c&&i+e.y===o)},[Piece.role.guard]:(t,i,c,o)=>{return[{x:1,y:1},{x:1,y:-1},{x:-1,y:1},{x:-1,y:-1}].some(e=>t+e.x===c&&i+e.y===o)},[Piece.role.elephant]:(t,i,c,o)=>{return[{x:2,y:2,xLim:1,yLim:1},{x:2,y:-2,xLim:1,yLim:-1},{x:-2,y:2,xLim:-1,yLim:1},{x:-2,y:-2,xLim:-1,yLim:-1}].some(e=>t+e.x===c&&i+e.y===o&&map[t+e.xLim][i+e.yLim].isEmpty())},[Piece.role.horse]:(t,i,c,o)=>{return[{x:-1,y:2,xLim:0,yLim:1},{x:1,y:2,xLim:0,yLim:1},{x:2,y:1,xLim:1,yLim:0},{x:2,y:-1,xLim:1,yLim:0},{x:1,y:-2,xLim:0,yLim:-1},{x:-1,y:-2,xLim:0,yLim:-1},{x:-2,y:-1,xLim:-1,yLim:0},{x:-2,y:1,xLim:-1,yLim:0}].some(e=>t+e.x===c&&i+e.y===o&&map[t+e.xLim][i+e.yLim].isEmpty())},[Piece.role.car]:(e,t,i,c)=>{var o,l;return e===i&&t!==c?([o,l]=t<c?[t,c]:[c,t],map[e].slice(o+1,l).every(e=>e.isEmpty())):t===c&&e!==i&&([o,l]=e<i?[e,i]:[i,e],map.slice(o+1,l).every(e=>e[t].isEmpty()))},[Piece.role.duck]:(t,i,c,o)=>{return[{dx:1,dy:1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:-1,dy:-1}].some(e=>t+3*e.dx===c&&i+2*e.dy===o&&map[t+2*e.dx][i+e.dy].isEmpty()&&map[t+e.dx][i].isEmpty()||t+2*e.dx===c&&i+3*e.dy===o&&map[t+e.dx][i+2*e.dy].isEmpty()&&map[t][i+e.dy].isEmpty())},[Piece.role.soldier]:(t,i,c,o)=>{return[{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:1},{x:0,y:-1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1}].some(e=>t+e.x===c&&i+e.y===o)}};constructor(e,t=0){this.type=e,this.team=t,this.name=Piece.str[e],this.cName=Piece.cName[e]}setPosition(e,t){this.x=e,this.y=t}canMoveTo(e,t){return!(e<0||t<0||e>=hSize||t>=wSize||this.team!==curTeam||map[e][t].team===curTeam)&&Piece.moveChk[this.type](this.x,this.y,e,t)}isEmpty(){return 0===this.type}onDeath(){1===this.type&&(curTeam=3,text=`${1===this.team?"蓝":"红"}方胜利`,curtain=curtainTime,textColor=curtainColor=1===this.team?"#00f":"#f00")}}class Rect{constructor(e,t,i,c){this.left=e,this.top=t,this.right=i,this.bottom=c}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get midx(){return(this.left+this.right)/2}get midy(){return(this.top+this.bottom)/2}}const initMap=[[new Piece(Piece.role.car,1),new Piece(Piece.role.horse,1),new Piece(Piece.role.elephant,1),new Piece(Piece.role.guard,1),new Piece(Piece.role.captain,1),new Piece(Piece.role.guard,1),new Piece(Piece.role.elephant,1),new Piece(Piece.role.horse,1),new Piece(Piece.role.car,1)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(Piece.role.duck,1),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(Piece.role.duck,1)],[new Piece(Piece.role.soldier,1),new Piece(0),new Piece(Piece.role.soldier,1),new Piece(0),new Piece(Piece.role.soldier,1),new Piece(0),new Piece(Piece.role.soldier,1),new Piece(0),new Piece(Piece.role.soldier,1)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(Piece.role.soldier,2),new Piece(0),new Piece(Piece.role.soldier,2),new Piece(0),new Piece(Piece.role.soldier,2),new Piece(0),new Piece(Piece.role.soldier,2),new Piece(0),new Piece(Piece.role.soldier,2)],[new Piece(Piece.role.duck,2),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(Piece.role.duck,2)],[new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0),new Piece(0)],[new Piece(Piece.role.car,2),new Piece(Piece.role.horse,2),new Piece(Piece.role.elephant,2),new Piece(Piece.role.guard,2),new Piece(Piece.role.captain,2),new Piece(Piece.role.guard,2),new Piece(Piece.role.elephant,2),new Piece(Piece.role.horse,2),new Piece(Piece.role.car,2)]],blockSize=80,boardRect=new Rect(40,40,40+wSize*blockSize,40+hSize*blockSize),textRect=new Rect(boardRect.left+10,boardRect.bottom+40,boardRect.right-10,boardRect.bottom+80),stageRect=new Rect(0,0,boardRect.right+40,textRect.bottom+40),menuRect=new Rect(stageRect.right,0,stageRect.right+600,stageRect.bottom),appRect=new Rect(0,0,menuRect.right,menuRect.bottom),errShowTime=40,shineTime=40,shakeTime=10,curtainTime=60,shakeDis=[0,1,1,2,2,3,4,6,9,13,20];let map=[],badClick=[],shine=[],canChoose=[],move=0,stage,ctx,menu,restart,text="红方下棋",textColor="#f00",curtain=0,curtainColor,windowWidth,windowHeight;function resize(){windowWidth=document.documentElement.clientWidth,windowHeight=document.documentElement.clientHeight;var e=Math.min(windowWidth/appRect.width,windowHeight/appRect.height);stage.css({width:stageRect.width*e,height:stageRect.height*e}),menu.css({width:menuRect.width*e,height:menuRect.height*e-200,fontSize:24*e,padding:20*e})}function init(){initMap.forEach((e,i)=>{map[i]=[...e],e.forEach((e,t)=>{e.setPosition(i,t)})}),badClick=Array(hSize).fill().map(()=>Array(wSize).fill(0)),shine=Array(hSize).fill().map(()=>Array(wSize).fill(0)),canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),stage=$(`<canvas width='${stageRect.width}' height='${stageRect.height}'></canvas>`),ctx=stage[0].getContext("2d"),menu=$("<div id='menu'><h3>菜单</h3><fieldset><legend>操作</legend></fieldset><fieldset><legend>关于</legend><p>这个项目由 <a href='https://github.com/caibyte'>caibyte</a> 编写</p><p><a href='https://github.com/caibyte/DuckchessOnline'>github链接</a><a href='http://alfredoj.natapp1.cc/static/games/DuckchessOnline/LICENSE.html'>MIT条款</a></p></fieldset><fieldset><legend>规则</legend><a href='https://www.luogu.com.cn/problem/P5380'>点我查看</a></fieldset></div>"),restart=$('<button class="btn">重新开始</button>'),menu.children("fieldset")[0].append(restart[0]),resize(),restart.click(()=>{initMap.forEach((e,i)=>{map[i]=[...e],e.forEach((e,t)=>{e.setPosition(i,t)})}),shine=Array(hSize).fill().map(()=>Array(wSize).fill(0)),canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),curTeam=1,text="红方下棋",textColor="#f00",curtainColor="#fff",curtain=curtainTime}),stage.click(e=>{console.log(e),click.push({x:e.offsetX/stage.width()*stageRect.width,y:e.offsetY/stage.height()*stageRect.height})}),stage.mousemove(e=>{var t=(boardRect.bottom-e.offsetY/stage.height()*stageRect.height)/blockSize|0,e=(e.offsetX/stage.width()*stageRect.width-boardRect.left)/blockSize|0;hovering=t<0||t>=hSize||e<0||e>=wSize?null:{x:t,y:e}}),$("#main").append(stage).append(menu),$("#loading").hide()}window.addEventListener("resize",resize);let curTeam=1,hovering=null,selecting=null,click=[];function update(){click.forEach(e=>{var i=(boardRect.bottom-e.y)/blockSize|0,c=(e.x-boardRect.left)/blockSize|0;if(!(i<0||i>=hSize||c<0||c>=wSize))if(null===selecting)if(map[i][c].team===curTeam){selecting={x:i,y:c};for(let t=0;t<hSize;++t)for(let e=0;e<wSize;++e)canChoose[t][e]=map[i][c].canMoveTo(t,e)}else canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),badClick[i][c]=errShowTime;else if(map[selecting.x][selecting.y].canMoveTo(i,c))curTeam=3-curTeam,text=`${1===curTeam?"红":"蓝"}方下棋`,textColor=1===curTeam?"#f00":"#00f",shine[selecting.x][selecting.y]=0,shine[i][c]=shineTime,move=shakeTime,canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),map[i][c].onDeath(),map[selecting.x][selecting.y].setPosition(i,c),map[i][c]=map[selecting.x][selecting.y],map[selecting.x][selecting.y]=new Piece(0),selecting=null;else if(map[i][c].team===curTeam){selecting={x:i,y:c};for(let t=0;t<hSize;++t)for(let e=0;e<wSize;++e)canChoose[t][e]=map[i][c].canMoveTo(t,e)}else selecting=null,canChoose=Array(hSize).fill().map(()=>Array(wSize).fill(!1)),badClick[i][c]=errShowTime}),click=[],curtain&&--curtain,move&&--move;for(let t=0;t<hSize;++t)for(let e=0;e<wSize;++e)badClick[t][e]&&--badClick[t][e],shine[t][e]&&--shine[t][e]}function render(){ctx.clearRect(stageRect.left,stageRect.top,stageRect.width,stageRect.height),ctx.save(),ctx.translate(0,shakeDis[move]);var e,t;ctx.fillStyle="#fd4",ctx.fillRect(boardRect.left,boardRect.top,boardRect.width,boardRect.height),ctx.strokeStyle="#640",ctx.lineWidth=3;for(let e=0;e<wSize;++e)ctx.beginPath(),ctx.moveTo(boardRect.left+blockSize/2+e*blockSize,boardRect.top+blockSize/2),ctx.lineTo(boardRect.left+blockSize/2+e*blockSize,boardRect.bottom-blockSize/2),ctx.stroke(),ctx.closePath(),ctx.fillStyle="#666",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="30px sans-serif",ctx.fillText(e,boardRect.left+blockSize/2+e*blockSize,boardRect.bottom+15);for(let e=0;e<hSize;++e)ctx.beginPath(),ctx.moveTo(boardRect.left+blockSize/2,boardRect.top+blockSize/2+e*blockSize),ctx.lineTo(boardRect.right-blockSize/2,boardRect.top+blockSize/2+e*blockSize),ctx.stroke(),ctx.closePath(),ctx.fillStyle="#666",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="30px sans-serif",ctx.fillText(hSize-e-1,boardRect.left-15,boardRect.top+blockSize/2+e*blockSize);hovering&&(map[hovering.x][hovering.y].team===curTeam||canChoose[hovering.x][hovering.y])&&(e=boardRect.left+blockSize/2+hovering.y*blockSize,t=boardRect.bottom-blockSize/2-hovering.x*blockSize,ctx.box(e,t,20,35,4,"#fff")),selecting&&(e=boardRect.left+blockSize/2+selecting.y*blockSize,t=boardRect.bottom-blockSize/2-selecting.x*blockSize,ctx.box(e,t,20,35,4,"#7f8"));for(let t=0;t<hSize;++t)for(let e=0;e<wSize;++e){var i=boardRect.left+blockSize/2+e*blockSize,c=boardRect.bottom-blockSize/2-t*blockSize;ctx.box(i,c,20,35,4,"#f44"+(badClick[t][e]/errShowTime*15|0).toString(16)),map[t][e].isEmpty()||(ctx.beginPath(),ctx.arc(i,6+c,30,0,2*Math.PI),ctx.fillStyle="#0007",ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.arc(i,c,30,0,2*Math.PI),ctx.fillStyle="#eee",ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.arc(i,3+c,30,0,2*Math.PI),ctx.fillStyle="#eee",ctx.fill(),ctx.closePath(),ctx.beginPath(),ctx.arc(i,c,26,0,2*Math.PI),ctx.strokeStyle=1===map[t][e].team?"#f00":"#00f",ctx.lineWidth=2,ctx.stroke(),ctx.closePath(),ctx.fillStyle=1===map[t][e].team?"#f00":"#00f",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="25px sans-serif",ctx.fillText(map[t][e].cName,i,c),ctx.beginPath(),ctx.arc(i,c,30,0,2*Math.PI),ctx.fillStyle="#fff"+(shine[t][e]/shineTime*13|0).toString(16),ctx.fill(),ctx.closePath()),canChoose[t][e]&&(ctx.beginPath(),ctx.arc(i,c,10,0,2*Math.PI),ctx.fillStyle="#3f4d",ctx.fill(),ctx.closePath())}ctx.fillStyle="#ccc",ctx.fillRect(textRect.left,textRect.top,textRect.width,textRect.height),ctx.fillStyle=textColor,ctx.textAlign="center",ctx.textBaseline="middle",ctx.font="30px sans-serif",ctx.fillText(text,textRect.midx,textRect.midy),curtain&&(ctx.fillStyle=curtainColor+(curtain/curtainTime*10|0).toString(16),ctx.fillRect(stageRect.left,stageRect.top,stageRect.width,stageRect.height)),ctx.restore()}function main(){update(),render(),requestAnimationFrame(main)}CanvasRenderingContext2D.prototype.box=function(e,t,i,c,o,l){this.strokeStyle=l,this.lineWidth=o,this.beginPath(),this.moveTo(e-c,t-c-o/2),this.lineTo(e-c,t-i),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e-c+o/2,t-c),this.lineTo(e-i,t-c),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+c,t-c-o/2),this.lineTo(e+c,t-i),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+c-o/2,t-c),this.lineTo(e+i,t-c),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e-c,t+c+o/2),this.lineTo(e-c,t+i),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e-c+o/2,t+c),this.lineTo(e-i,t+c),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+c,t+c+o/2),this.lineTo(e+c,t+i),this.stroke(),this.closePath(),this.beginPath(),this.moveTo(e+c-o/2,t+c),this.lineTo(e+i,t+c),this.stroke(),this.closePath()},window.addEventListener("load",()=>{init(),main()});